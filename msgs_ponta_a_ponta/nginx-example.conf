# Configuração Nginx para P2P Chat Deployment
# 
# INSTALAÇÃO:
# 1. Instale nginx: sudo apt-get install nginx
# 2. Copie este arquivo: sudo cp nginx-example.conf /etc/nginx/sites-available/seu-dominio.com
# 3. Crie symlink: sudo ln -s /etc/nginx/sites-available/seu-dominio.com /etc/nginx/sites-enabled/
# 4. Teste config: sudo nginx -t
# 5. Recarregue: sudo systemctl reload nginx
# 6. Gere SSL: sudo certbot --nginx -d seu-dominio.com -d www.seu-dominio.com
#
# SUBSTITUA:
#   - "seu-dominio.com" → seu domínio real
#   - "127.0.0.1:3000" → IP:porta do dashboard (se não local)
#   - "127.0.0.1:8080" → IP:porta do servidor WebSocket (se não local)

# HTTP redirect to HTTPS
server {
  listen 80;
  listen [::]:80;
  server_name seu-dominio.com www.seu-dominio.com;
  
  # Certbot ACME challenge
  location /.well-known/acme-challenge/ {
    root /var/www/certbot;
  }
  
  # Redireciona HTTP → HTTPS
  location / {
    return 301 https://$host$request_uri;
  }
}

# HTTPS server - Dashboard API e Frontend
server {
  listen 443 ssl http2;
  listen [::]:443 ssl http2;
  server_name seu-dominio.com www.seu-dominio.com;

  # ============================================
  # SSL Certificates (gerados por Certbot)
  # ============================================
  ssl_certificate /etc/letsencrypt/live/seu-dominio.com/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/seu-dominio.com/privkey.pem;

  # SSL Security headers
  add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
  add_header X-Frame-Options "SAMEORIGIN" always;
  add_header X-Content-Type-Options "nosniff" always;
  add_header X-XSS-Protection "1; mode=block" always;

  # Logs
  access_log /var/log/nginx/seu-dominio.com-access.log;
  error_log /var/log/nginx/seu-dominio.com-error.log;

  # ============================================
  # Root - serve arquivos estáticos do dashboard
  # ============================================
  root /path/to/msgs_ponta_a_ponta/dashboard/public;
  index index.html view.html;

  # ============================================
  # API Routes (proxy para Node.js)
  # ============================================
  location /api/ {
    # CORS headers
    add_header 'Access-Control-Allow-Origin' 'https://seu-dominio.com' always;
    add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
    add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization' always;
    add_header 'Access-Control-Max-Age' 1728000 always;

    # Handle preflight requests
    if ($request_method = 'OPTIONS') {
      add_header 'Content-Type' 'text/plain; charset=utf-8';
      add_header 'Content-Length' 0;
      return 204;
    }

    # Proxy para Node.js (Dashboard - porta 3000)
    proxy_pass http://127.0.0.1:3000;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_redirect off;
  }

  # ============================================
  # WebSocket (Signaling Server)
  # ============================================
  location /ws {
    # Proxy para WebSocket Server (porta 8080)
    proxy_pass http://127.0.0.1:8080;
    proxy_http_version 1.1;
    
    # Headers obrigatórios para WebSocket
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "Upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # Timeouts para conexões de longa duração (WebSocket)
    proxy_read_timeout 3600s;
    proxy_send_timeout 3600s;
    proxy_connect_timeout 10s;
    
    # Buffers
    proxy_buffering off;
  }

  # ============================================
  # Static Files (css, js, icons, etc)
  # ============================================
  location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
    expires 30d;
    add_header Cache-Control "public, immutable";
  }

  # ============================================
  # index.html fallback para SPA
  # ============================================
  location / {
    try_files $uri $uri/ /view.html;
  }

  # ============================================
  # Deny access to sensitive files
  # ============================================
  location ~ /\. {
    deny all;
  }

  location ~ ~$ {
    deny all;
  }
}

# ============================================
# OPCIONAL: Subdomínio dedicado para WebSocket
# (descomente se quiser ws.seu-dominio.com)
# ============================================
# server {
#   listen 443 ssl http2;
#   listen [::]:443 ssl http2;
#   server_name ws.seu-dominio.com;
#
#   ssl_certificate /etc/letsencrypt/live/seu-dominio.com/fullchain.pem;
#   ssl_certificate_key /etc/letsencrypt/live/seu-dominio.com/privkey.pem;
#
#   location / {
#     proxy_pass http://127.0.0.1:8080;
#     proxy_http_version 1.1;
#     proxy_set_header Upgrade $http_upgrade;
#     proxy_set_header Connection "Upgrade";
#     proxy_set_header Host $host;
#     proxy_set_header X-Real-IP $remote_addr;
#     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#     proxy_set_header X-Forwarded-Proto $scheme;
#     proxy_read_timeout 3600s;
#     proxy_send_timeout 3600s;
#     proxy_buffering off;
#   }
# }
